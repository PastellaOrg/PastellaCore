# GitLab CI for PastellaCore
# Builds for Linux x86_64, Linux ARM64, and Windows x86_64

stages:
  - build
  - package

variables:
  GIT_SUBMODULE_STRATEGY: recursive
  GIT_DEPTH: 3

# ============================================
# Linux x86_64 Build
# ============================================
build-linux-x64:
  stage: build
  when: manual  # Manually triggered - Windows build is priority for testing
  image: ubuntu:22.04
  script:
    - echo "Building Linux x86_64..."
    # Install dependencies
    - apt-get update -qq
    - apt-get install -y -qq
        build-essential
        cmake
        git
        libboost-all-dev
        libssl-dev
        libpthread-stubs0-dev
    # Configure and build
    - mkdir -p build && cd build
    - cmake .. -DCMAKE_BUILD_TYPE=Release
    - make -j$(nproc)
  artifacts:
    name: "linux-x64-$CI_COMMIT_SHORT_SHA"
    paths:
      - build/src/Pastellad
      - build/src/Pastella-Wallet
      - build/src/Pastella-Wallet-API
    expire_in: 1 week
  cache:
    key: linux-x64-$CI_COMMIT_REF_SLUG
    paths:
      - build/

# ============================================
# Linux ARM64 Build (Cross-compile with QEMU)
# ============================================
build-linux-arm64:
  stage: build
  when: manual  # Manually triggered - Windows build is priority for testing
  image: ubuntu:22.04
  script:
    - echo "Building Linux ARM64..."
    # Install dependencies including QEMU for ARM64 emulation
    - apt-get update -qq
    - apt-get install -y -qq
        build-essential
        cmake
        git
        libboost-all-dev
        libssl-dev
        libpthread-stubs0-dev
        qemu-user-static
        binfmt-support
    # Configure and build for ARM64
    - mkdir -p build && cd build
    - cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_SYSTEM_PROCESSOR=aarch64 -DNO_AES=ON
    - make -j$(nproc)
  artifacts:
    name: "linux-arm64-$CI_COMMIT_SHORT_SHA"
    paths:
      - build/src/Pastellad
      - build/src/Pastella-Wallet
      - build/src/Pastella-Wallet-API
    expire_in: 1 week
  cache:
    key: linux-arm64-$CI_COMMIT_REF_SLUG
    paths:
      - build/
  allow_failure: true  # ARM64 build is optional

# ============================================
# Windows x86_64 Build (Native Windows Runner)
# ============================================
build-windows-x64:
  stage: build
  tags:
    - windows  # Uses your Windows Server runner with shell executor
  script:
    - echo "Building Windows x86_64 (native)..."
    # Install dependencies via vcpkg if not cached
    - if (-not (Test-Path "vcpkg")) { git clone https://github.com/Microsoft/vcpkg.git; .\vcpkg\bootstrap-vcpkg.bat }
    # Install required packages via vcpkg (static, x64-windows)
    - .\vcpkg\vcpkg install boost-variant:x64-windows-static boost-optional:x64-windows-static boost-algorithm:x64-windows-static boost-format:x64-windows-static boost-scope-exit:x64-windows-static boost-range:x64-windows-static boost-iterator:x64-windows-static boost-integer:x64-windows-static boost-functional:x64-windows-static boost-utility:x64-windows-static boost-foreach:x64-windows-static boost-multi-index:x64-windows-static boost-uuid:x64-windows-static boost-date-time:x64-windows-static boost-system:x64-windows-static boost-thread:x64-windows-static boost-chrono:x64-windows-static boost-serialization:x64-windows-static openssl:x64-windows-static
    # Create build directory
    - New-Item -ItemType Directory -Force -Path build
    - cd build
    # Configure with Visual Studio and vcpkg toolchain
    - cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE="../vcpkg/scripts/buildsystems/vcpkg.cmake" -DVCPKG_TARGET_TRIPLET=x64-windows-static -A x64
    # Build
    - cmake --build . --config Release -- /m
  artifacts:
    name: "windows-x64-$CI_COMMIT_SHORT_SHA"
    paths:
      - build/src/Release/Pastellad.exe
      - build/src/Release/Pastella-Wallet.exe
      - build/src/Release/Pastella-Wallet-API.dll
      - build/src/Release/*.exe
    expire_in: 1 week
  cache:
    key: windows-x64-$CI_COMMIT_REF_SLUG
    paths:
      - build/
      - vcpkg/

# ============================================
# Release Package (Linux x64)
# ============================================
package-linux-x64:
  stage: package
  image: ubuntu:22.04
  dependencies:
    - build-linux-x64
  script:
    - echo "Packaging Linux x64 binaries..."
    - mkdir -p release/linux-x64
    - cp build/src/Pastellad build/src/Pastella-Wallet build/src/Pastella-Wallet-API release/linux-x64/
    - cd release && tar -czf pastellacore-linux-x64-$CI_COMMIT_TAG.tar.gz linux-x64/
  artifacts:
    name: "pastellacore-linux-x64-package"
    paths:
      - release/*.tar.gz
    expire_in: 1 month
  only:
    - tags
    - main

# ============================================
# Release Package (Linux ARM64)
# ============================================
package-linux-arm64:
  stage: package
  image: ubuntu:22.04
  dependencies:
    - build-linux-arm64
  script:
    - echo "Packaging Linux ARM64 binaries..."
    - mkdir -p release/linux-arm64
    - cp build/src/Pastellad build/src/Pastella-Wallet build/src/Pastella-Wallet-API release/linux-arm64/
    - cd release && tar -czf pastellacore-linux-arm64-$CI_COMMIT_TAG.tar.gz linux-arm64/
  artifacts:
    name: "pastellacore-linux-arm64-package"
    paths:
      - release/*.tar.gz
    expire_in: 1 month
  only:
    - tags
    - main

# ============================================
# Release Package (Windows x64)
# ============================================
package-windows-x64:
  stage: package
  tags:
    - windows
  dependencies:
    - build-windows-x64
  script:
    - echo "Packaging Windows x64 binaries..."
    - New-Item -ItemType Directory -Force -Path release/windows-x64
    - Copy-Item build/src/Release/*.exe release/windows-x64/
    - Copy-Item build/src/Release/*.dll release/windows-x64/
    - Compress-Archive -Path release/windows-x64/* -DestinationPath pastellacore-windows-x64-$CI_COMMIT_TAG.zip
  artifacts:
    name: "pastellacore-windows-x64-package"
    paths:
      - "*.zip"
    expire_in: 1 month
  only:
    - tags
    - main
