# GitLab CI for PastellaCore
# Builds for Linux x86_64 and Windows x86_64

stages:
  - build
  - package

variables:
  GIT_SUBMODULE_STRATEGY: recursive
  GIT_DEPTH: 3

# ============================================
# Linux x86_64 Build
# ============================================
build-linux:
  stage: build
  image: ubuntu:22.04
  script:
    - echo "Building Linux x86_64..."
    # Install dependencies
    - apt-get update -qq
    - apt-get install -y -qq
        build-essential
        cmake
        git
        libboost-all-dev
        libssl-dev
        libpthread-stubs0-dev
    # Configure and build
    - mkdir -p build && cd build
    - cmake .. -DCMAKE_BUILD_TYPE=Release
    - make -j$(nproc)
  artifacts:
    name: "linux-x64-$CI_COMMIT_SHORT_SHA"
    paths:
      - build/src/Pastellad
      - build/src/Pastella-Wallet
      - build/src/Pastella-Wallet-API
    expire_in: 1 week
  cache:
    key: linux-$CI_COMMIT_REF_SLUG
    paths:
      - build/

# ============================================
# Windows x86_64 Build (Native Windows Runner)
# ============================================
build-windows:
  stage: build
  tags:
    - windows  # Uses your Windows Server runner with shell executor
  script:
    - echo "Building Windows x86_64 (native)..."
    # Install dependencies via vcpkg if not cached
    - if (-not (Test-Path "vcpkg")) { git clone https://github.com/Microsoft/vcpkg.git; .\vcpkg\bootstrap-vcpkg.bat }
    # Install required packages via vcpkg (static, x64-windows)
    - .\vcpkg\vcpkg install boost-system:x64-windows-static boost-thread:x64-windows-static boost-date-time:x64-windows-static boost-chrono:x64-windows-static boost-serialization:x64-windows-static boost-uuid:x64-windows-static openssl:x64-windows-static
    # Create build directory
    - New-Item -ItemType Directory -Force -Path build
    - cd build
    # Configure with Visual Studio and vcpkg toolchain
    - cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE="../vcpkg/scripts/buildsystems/vcpkg.cmake" -DVCPKG_TARGET_TRIPLET=x64-windows-static -DWITH_LEVELDB=ON -A x64
    # Build
    - cmake --build . --config Release -j
  artifacts:
    name: "windows-x64-$CI_COMMIT_SHORT_SHA"
    paths:
      - build/src/Release/Pastellad.exe
      - build/src/Release/Pastella-Wallet.exe
      - build/src/Release/Pastella-Wallet-API.dll
      - build/src/Release/*.exe
    expire_in: 1 week
  cache:
    key: windows-$CI_COMMIT_REF_SLUG
    paths:
      - build/
      - vcpkg/

# ============================================
# Release Package (Linux)
# ============================================
package-linux:
  stage: package
  image: ubuntu:22.04
  dependencies:
    - build-linux
  script:
    - echo "Packaging Linux binaries..."
    - mkdir -p release/linux
    - cp build/src/Pastellad build/src/Pastella-Wallet build/src/Pastella-Wallet-API release/linux/
    - cd release && tar -czf pastellacore-linux-x64-$CI_COMMIT_TAG.tar.gz linux/
  artifacts:
    name: "pastellacore-linux-package"
    paths:
      - release/*.tar.gz
    expire_in: 1 month
  only:
    - tags
    - main

# ============================================
# Release Package (Windows)
# ============================================
package-windows:
  stage: package
  tags:
    - windows
  dependencies:
    - build-windows
  script:
    - echo "Packaging Windows binaries..."
    - New-Item -ItemType Directory -Force -Path release/windows
    - Copy-Item build/src/Release/*.exe release/windows/
    - Copy-Item build/src/Release/*.dll release/windows/
    - Compress-Archive -Path release/windows/* -DestinationPath pastellacore-windows-x64-$CI_COMMIT_TAG.zip
  artifacts:
    name: "pastellacore-windows-package"
    paths:
      - "*.zip"
    expire_in: 1 month
  only:
    - tags
    - main
