# GitLab CI for PastellaCore
# Builds for Linux x86_64, Linux ARM64, and Windows x86_64

stages:
  - build
  - package

variables:
  GIT_SUBMODULE_STRATEGY: recursive
  GIT_DEPTH: 3

# ============================================
# Linux x86_64 Build
# ============================================
build-linux-x64:
  stage: build
  when: manual  # Manually triggered - Windows build is priority for testing
  image: ubuntu:22.04
  script:
    - echo "Building Linux x86_64..."
    # Install dependencies
    - apt-get update -qq
    - apt-get install -y -qq
        build-essential
        cmake
        git
        libboost-all-dev
        libssl-dev
        libpthread-stubs0-dev
    # Configure and build
    - mkdir -p build && cd build
    - cmake .. -DCMAKE_BUILD_TYPE=Release
    - make -j$(nproc)
  artifacts:
    name: "linux-x64-$CI_COMMIT_SHORT_SHA"
    paths:
      - build/src/Pastellad
      - build/src/Pastella-Wallet
      - build/src/Pastella-Wallet-API
    expire_in: 1 week
  cache:
    key: linux-x64-$CI_COMMIT_REF_SLUG
    paths:
      - build/

# ============================================
# Linux ARM64 Build (Cross-compile with QEMU)
# ============================================
build-linux-arm64:
  stage: build
  when: manual  # Manually triggered - Windows build is priority for testing
  image: ubuntu:22.04
  script:
    - echo "Building Linux ARM64..."
    # Install dependencies including QEMU for ARM64 emulation
    - apt-get update -qq
    - apt-get install -y -qq
        build-essential
        cmake
        git
        libboost-all-dev
        libssl-dev
        libpthread-stubs0-dev
        qemu-user-static
        binfmt-support
    # Configure and build for ARM64
    - mkdir -p build && cd build
    - cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_SYSTEM_PROCESSOR=aarch64 -DNO_AES=ON
    - make -j$(nproc)
  artifacts:
    name: "linux-arm64-$CI_COMMIT_SHORT_SHA"
    paths:
      - build/src/Pastellad
      - build/src/Pastella-Wallet
      - build/src/Pastella-Wallet-API
    expire_in: 1 week
  cache:
    key: linux-arm64-$CI_COMMIT_REF_SLUG
    paths:
      - build/
  allow_failure: true  # ARM64 build is optional

# ============================================
# Windows x86_64 Build (Native Windows Runner)
# ============================================
build-windows-x64:
  stage: build
  tags:
    - windows
  variables:
    MSYS2_ROOT: "C:\\msys64"
    MSYS2_BASH: "C:\\msys64\\usr\\bin\\bash.exe"
    BOOST_ROOT_WIN: "C:\\boost_1_68_0"
    BOOST_ROOT_UNIX: "/c/boost_1_68_0"
  before_script:
    # 1. MSYS2 Install
    - |
      if (!(Test-Path $env:MSYS2_ROOT)) {
        Write-Host "MSYS2 not found. Downloading..."
        $url = "https://github.com/msys2/msys2-installer/releases/download/2024-05-07/msys2-x86_64-20240507.exe"
        Invoke-WebRequest -Uri $url -OutFile "msys2_installer.exe"
        Start-Process -FilePath ".\msys2_installer.exe" -ArgumentList "--confirm-command", "--accept-licenses", "--root", $env:MSYS2_ROOT, "install" -Wait
        Remove-Item ".\msys2_installer.exe"
      }

    # 2. Boost Download
    - |
      if (!(Test-Path $env:BOOST_ROOT_WIN)) {
        Write-Host "Downloading Boost 1.68 Source..."
        Invoke-WebRequest -Uri "https://archives.boost.io/release/1.68.0/source/boost_1_68_0.tar.gz" -OutFile "boost_1_68_0.tar.gz"
        tar -xzf boost_1_68_0.tar.gz -C C:\
        Remove-Item "boost_1_68_0.tar.gz"
      }

    # 3. Boost Compilation
    - |
      if (!(Test-Path "$env:BOOST_ROOT_WIN\b2.exe")) {
        Write-Host "Bootstrapping Boost..."
        cd $env:BOOST_ROOT_WIN
        .\bootstrap.bat gcc
      }
      if (!(Test-Path "$env:BOOST_ROOT_WIN\stage")) {
        Write-Host "Compiling Boost libraries..."
        & $env:MSYS2_BASH -c "cd $env:BOOST_ROOT_UNIX && ./b2 toolset=gcc link=static threading=multi runtime-link=static --with-system --with-thread --with-date_time --with-chrono --with-serialization stage"
      }

    # 4. Dependencies (Avoid mingw-w64-x86_64-boost here to prevent 1.90 conflict)
    - >
      & $env:MSYS2_BASH -lc "pacman -S --needed --noconfirm 
      mingw-w64-x86_64-toolchain mingw-w64-x86_64-cmake mingw-w64-x86_64-ccache 
      mingw-w64-x86_64-openssl mingw-w64-x86_64-zeromq mingw-w64-x86_64-libsodium 
      mingw-w64-x86_64-hidapi mingw-w64-x86_64-protobuf-c mingw-w64-x86_64-libusb 
      mingw-w64-x86_64-unbound make git"

  script:
    - echo "Building Windows x86_64 with MSYS2/MinGW..."
    # REMOVED -lc and ADDED manual PATH export to fix "cmake not found"
    - >
      & $env:MSYS2_BASH -c "
      export PATH='/mingw64/bin:/usr/bin:$PATH' &&
      rm -rf build &&
      mkdir -p build &&
      cd build &&
      cmake .. -G 'Unix Makefiles' 
      -DCMAKE_BUILD_TYPE=Release 
      -DBOOST_ROOT='$BOOST_ROOT_UNIX' 
      -DBoost_NO_SYSTEM_PATHS=ON 
      -DBoost_NO_BOOST_CMAKE=ON &&
      make -j2"
  artifacts:
    name: "windows-x64-$CI_COMMIT_SHORT_SHA"
    paths:
      - build/src/Pastellad.exe
      - build/src/Pastella-Wallet.exe
      - build/src/Pastella-Wallet-API.dll
    expire_in: 1 week
  cache:
    key: windows-x64-cache
    paths:
      - .ccache/
      
# ============================================
# Release Package (Linux x64)
# ============================================
package-linux-x64:
  stage: package
  image: ubuntu:22.04
  dependencies:
    - build-linux-x64
  script:
    - echo "Packaging Linux x64 binaries..."
    - mkdir -p release/linux-x64
    - cp build/src/Pastellad build/src/Pastella-Wallet build/src/Pastella-Wallet-API release/linux-x64/
    - cd release && tar -czf pastellacore-linux-x64-$CI_COMMIT_TAG.tar.gz linux-x64/
  artifacts:
    name: "pastellacore-linux-x64-package"
    paths:
      - release/*.tar.gz
    expire_in: 1 month
  only:
    - tags
    - main

# ============================================
# Release Package (Linux ARM64)
# ============================================
package-linux-arm64:
  stage: package
  image: ubuntu:22.04
  dependencies:
    - build-linux-arm64
  script:
    - echo "Packaging Linux ARM64 binaries..."
    - mkdir -p release/linux-arm64
    - cp build/src/Pastellad build/src/Pastella-Wallet build/src/Pastella-Wallet-API release/linux-arm64/
    - cd release && tar -czf pastellacore-linux-arm64-$CI_COMMIT_TAG.tar.gz linux-arm64/
  artifacts:
    name: "pastellacore-linux-arm64-package"
    paths:
      - release/*.tar.gz
    expire_in: 1 month
  only:
    - tags
    - main

# ============================================
# Release Package (Windows x64)
# ============================================
package-windows-x64:
  stage: package
  tags:
    - windows
  dependencies:
    - build-windows-x64
  script:
    - echo "Packaging Windows x64 binaries..."
    - New-Item -ItemType Directory -Force -Path release/windows-x64
    - Copy-Item build/src/Release/*.exe release/windows-x64/
    - Copy-Item build/src/Release/*.dll release/windows-x64/
    - Compress-Archive -Path release/windows-x64/* -DestinationPath pastellacore-windows-x64-$CI_COMMIT_TAG.zip
  artifacts:
    name: "pastellacore-windows-x64-package"
    paths:
      - "*.zip"
    expire_in: 1 month
  only:
    - tags
    - main
