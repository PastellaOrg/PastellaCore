# GitLab CI for PastellaCore
# Builds for Linux x86_64, Linux ARM64, and Windows x86_64 (cross-compiled from Linux)

stages:
  - build
  - package

variables:
  GIT_SUBMODULE_STRATEGY: recursive
  GIT_DEPTH: 3

# ============================================
# Debian x86_64 Build
# ============================================
build-debian-x64:
  stage: build
  image: ubuntu:22.04
  script:
    - echo "Building Linux x86_64 (static build with depends)..."
    # Install dependencies
    - apt-get update -qq
    - apt-get install -y -qq
        build-essential
        cmake
        git
        python3
        curl
    # Build dependencies for Linux x64
    - make depends-linux -j8
    # Build Linux x64 static binary
    - make release-static-linux-x86_64 -j8
  artifacts:
    name: "linux-x64-$CI_COMMIT_SHORT_SHA"
    paths:
      - build/release/x86_64-linux-gnu/src/Pastellad
      - build/release/x86_64-linux-gnu/src/Pastella-Wallet
      - build/release/x86_64-linux-gnu/src/Pastella-Wallet-API
    expire_in: 1 week

# ============================================
# Debian ARM64 Build
# ============================================
build-debian-arm64:
  stage: build
  image: ubuntu:22.04
  script:
    - echo "Building Linux ARM64 (cross-compile from x86_64)..."
    # Install dependencies for musl-cross (32-bit runtime needed for musl.cc toolchain)
    - apt-get update -qq
    - dpkg --add-architecture i386
    - apt-get update -qq
    - apt-get install -y -qq
        build-essential
        cmake
        git
        python3
        curl
        libc6:i386
        libstdc++6:i386
        libgcc-s1:i386
        gcc-aarch64-linux-gnu
        g++-aarch64-linux-gnu
    # Build dependencies for Linux ARM64 (downloads and sets up musl-cross)
    - make depends-linux-arm64 -j8
    # Build Linux ARM64 static binary (uses musl-cross from depends)
    - make release-static-linux-arm64 -j8
  artifacts:
    name: "linux-arm64-$CI_COMMIT_SHORT_SHA"
    paths:
      - build/release/arm64-linux/src/Pastellad
      - build/release/arm64-linux/src/Pastella-Wallet
      - build/release/arm64-linux/src/Pastella-Wallet-API
    expire_in: 1 week

# ============================================
# Windows x86_64 Build (Cross-compile from Linux)
# ============================================
build-windows-x64:
  stage: build
  image: ubuntu:22.04
  script:
    - echo "Building Windows x86_64 (cross-compile from Linux)..."
    # Install dependencies
    - apt-get update -qq
    - apt-get install -y -qq
        build-essential
        cmake
        git
        python3
        g++-mingw-w64-x86-64-posix
        g++-mingw-w64-i686-posix
        mingw-w64-tools
        curl
    # Set POSIX MinGW as default for cross-compilation
    - update-alternatives --set x86_64-w64-mingw32-g++ /usr/bin/x86_64-w64-mingw32-g++-posix
    - update-alternatives --set x86_64-w64-mingw32-gcc /usr/bin/x86_64-w64-mingw32-gcc-posix
    # Build dependencies for Windows x64
    - make depends-win64 -j8
    # Build Windows x64 static binary
    - make release-static-win64 -j8
  artifacts:
    name: "windows-x64-$CI_COMMIT_SHORT_SHA"
    paths:
      - build/release/x86_64-w64-mingw32/src/Pastellad.exe
      - build/release/x86_64-w64-mingw32/src/Pastella-Wallet.exe
      - build/release/x86_64-w64-mingw32/src/Pastella-Wallet-API.exe
    expire_in: 1 week

# ============================================
# Arch Linux x86_64 Build
# ============================================
build-arch-x64:
  stage: build
  image: archlinux:latest
  script:
    - echo "Building Arch Linux x86_64..."
    # Install dependencies
    - pacman -Sy --noconfirm
        base-devel
        cmake
        git
        python3
        curl
    # Arch Linux uses unprefixed toolchain (ar, ranlib) vs Debian (x86_64-linux-gnu-ar, x86_64-linux-gnu-ranlib)
    # Create symlinks so depends/Boost build can find the prefixed tools it expects
    - mkdir -p /usr/local/bin
    - ln -sf /usr/bin/ar /usr/local/bin/x86_64-linux-gnu-ar
    - ln -sf /usr/bin/ranlib /usr/local/bin/x86_64-linux-gnu-ranlib
    - ln -sf /usr/bin/gcc /usr/local/bin/x86_64-linux-gnu-gcc
    - ln -sf /usr/bin/g++ /usr/local/bin/x86_64-linux-gnu-g++
    - ln -sf /usr/bin/strip /usr/local/bin/x86_64-linux-gnu-strip
    - ln -sf /usr/bin/nm /usr/local/bin/x86_64-linux-gnu-nm
    - ln -sf /usr/bin/objdump /usr/local/bin/x86_64-linux-gnu-objdump
    # Add /usr/local/bin to PATH so depends finds our symlinks first
    - export PATH="/usr/local/bin:$PATH"
    # Build dependencies for Linux x64
    - make depends-linux -j8
    # Build Linux x64 static binary
    - make release-static-linux-x86_64 -j8
  artifacts:
    name: "arch-x64-$CI_COMMIT_SHORT_SHA"
    paths:
      - build/release/x86_64-linux-gnu/src/Pastellad
      - build/release/x86_64-linux-gnu/src/Pastella-Wallet
      - build/release/x86_64-linux-gnu/src/Pastella-Wallet-API
    expire_in: 1 week

# ============================================
# macOS x86_64 Build (Cross-compile from Linux)
# ============================================
build-macos-x64:
  stage: build
  image: ubuntu:22.04
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    OSX_VERSION_MIN: "10.15"
  before_script:
    # Install Linux dependencies
    - apt-get update -qq && apt-get install -y -qq
        build-essential
        cmake
        git
        python3
        curl
        docker.io
    # Extract osxcross toolchain from Docker image
    - echo "Extracting macOS toolchain..."
    - docker create --name osx-tools crazymax/osxcross:latest-ubuntu
    - docker cp osx-tools:/opt/osxcross ./osxcross
    - docker rm osx-tools
    - export PATH="$(pwd)/osxcross/target/bin:$PATH"
    - export CMAKE_LIBRARY_PATH="$(pwd)/osxcross/target/lib/x86_64-apple-darwin:$CMAKE_LIBRARY_PATH"
    - export CMAKE_INCLUDE_PATH="$(pwd)/osxcross/target/include:$CMAKE_INCLUDE_PATH"
    - export OSXCROSS_TARGET_DIR="$(pwd)/osxcross/target"
  script:
    - echo "Building macOS x64 static binary..."
    - make release-static-mac-x86_64 -j8
  artifacts:
    name: "macos-x64-$CI_COMMIT_SHORT_SHA"
    paths:
      - build/release/x86_64-apple-darwin/src/Pastellad
      - build/release/x86_64-apple-darwin/src/Pastella-Wallet
      - build/release/x86_64-apple-darwin/src/Pastella-Wallet-API
    expire_in: 1 week

# ============================================
# macOS ARM64 Build (Cross-compile from Linux)
# ============================================
build-macos-arm64:
  stage: build
  image: ubuntu:22.04
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    OSX_VERSION_MIN: "11.0"
  before_script:
    # Install Linux dependencies
    - apt-get update -qq && apt-get install -y -qq
        build-essential
        cmake
        git
        python3
        curl
        docker.io
    # Extract osxcross toolchain from Docker image
    - echo "Extracting macOS ARM64 toolchain..."
    - docker create --name osx-tools-arm64 crazymax/osxcross:latest-ubuntu
    - docker cp osx-tools-arm64:/opt/osxcross ./osxcross
    - docker rm osx-tools-arm64
    - export PATH="$(pwd)/osxcross/target/bin:$PATH"
    - export CMAKE_LIBRARY_PATH="$(pwd)/osxcross/target/lib/aarch64-apple-darwin:$CMAKE_LIBRARY_PATH"
    - export CMAKE_INCLUDE_PATH="$(pwd)/osxcross/target/include:$CMAKE_INCLUDE_PATH"
    - export OSXCROSS_TARGET_DIR="$(pwd)/osxcross/target"
  script:
    - echo "Building macOS ARM64 static binary..."
    - make release-static-mac-arm64 -j8
  artifacts:
    name: "macos-arm64-$CI_COMMIT_SHORT_SHA"
    paths:
      - build/release/arm64-apple-darwin/src/Pastellad
      - build/release/arm64-apple-darwin/src/Pastella-Wallet
      - build/release/arm64-apple-darwin/src/Pastella-Wallet-API
    expire_in: 1 week



# ============================================
# Release Package (Debian x64)
# ============================================
package-debian-x64:
  stage: package
  image: ubuntu:22.04
  dependencies:
    - build-debian-x64
  script:
    - echo "Packaging Linux x64 binaries..."
    - apt-get update -qq && apt-get install -y -qq tar
    - mkdir -p release/linux-x64
    - cp build/release/x86_64-linux-gnu/src/Pastellad build/release/x86_64-linux-gnu/src/Pastella-Wallet build/release/x86_64-linux-gnu/src/Pastella-Wallet-API release/linux-x64/
    - cd release && tar -czf pastellacore-linux-x64-$CI_COMMIT_TAG.tar.gz linux-x64/
  artifacts:
    name: "pastellacore-linux-x64-package"
    paths:
      - release/*.tar.gz
    expire_in: 1 month
  only:
    - tags
    - main

# ============================================
# Release Package (Debian ARM64)
# ============================================
package-debian-arm64:
  stage: package
  image: ubuntu:22.04
  dependencies:
    - build-debian-arm64
  script:
    - echo "Packaging Linux ARM64 binaries..."
    - apt-get update -qq && apt-get install -y -qq tar
    - mkdir -p release/linux-arm64
    - cp build/release/arm64-linux/src/Pastellad build/release/arm64-linux/src/Pastella-Wallet build/release/arm64-linux/src/Pastella-Wallet-API release/linux-arm64/
    - cd release && tar -czf pastellacore-linux-arm64-$CI_COMMIT_TAG.tar.gz linux-arm64/
  artifacts:
    name: "pastellacore-linux-arm64-package"
    paths:
      - release/*.tar.gz
    expire_in: 1 month
  only:
    - tags
    - main

# ============================================
# Release Package (Windows x64)
# ============================================
package-windows-x64:
  stage: package
  image: ubuntu:22.04
  dependencies:
    - build-windows-x64
  script:
    - echo "Packaging Windows x64 binaries..."
    - apt-get update -qq && apt-get install -y -qq zip
    - mkdir -p release/windows-x64
    - cp build/release/x86_64-w64-mingw32/src/*.exe release/windows-x64/
    - cd release && zip -r pastellacore-windows-x64-$CI_COMMIT_TAG.zip windows-x64/
  artifacts:
    name: "pastellacore-windows-x64-package"
    paths:
      - release/*.zip
    expire_in: 1 month
  only:
    - tags
    - main

# ============================================
# Release Package (Arch Linux x64)
# ============================================
package-arch-x64:
  stage: package
  image: archlinux:latest
  dependencies:
    - build-arch-x64
  script:
    - echo "Packaging Arch Linux x64 binaries..."
    - pacman -Sy --noconfirm tar
    - mkdir -p release/arch-x64
    - cp build/release/x86_64-linux-gnu/src/Pastellad build/release/x86_64-linux-gnu/src/Pastella-Wallet build/release/x86_64-linux-gnu/src/Pastella-Wallet-API release/arch-x64/
    - cd release && tar -czf pastellacore-arch-x64-$CI_COMMIT_TAG.tar.gz arch-x64/
  artifacts:
    name: "pastellacore-arch-x64-package"
    paths:
      - release/*.tar.gz
    expire_in: 1 month
  only:
    - tags
    - main

# ============================================
# Release Package (macOS x64)
# ============================================
package-macos-x64:
  stage: package
  image: ubuntu:22.04
  dependencies:
    - build-macos-x64
  script:
    - echo "Packaging macOS x64 binaries..."
    - apt-get update -qq && apt-get install -y -qq tar
    - mkdir -p release/macos-x64
    - cp build/release/x86_64-apple-darwin/src/Pastellad build/release/x86_64-apple-darwin/src/Pastella-Wallet build/release/x86_64-apple-darwin/src/Pastella-Wallet-API release/macos-x64/
    - cd release && tar -czf pastellacore-macos-x64-$CI_COMMIT_TAG.tar.gz macos-x64/
  artifacts:
    name: "pastellacore-macos-x64-package"
    paths:
      - release/*.tar.gz
    expire_in: 1 month
  only:
    - tags
    - main

# ============================================
# Release Package (macOS ARM64)
# ============================================
package-macos-arm64:
  stage: package
  image: ubuntu:22.04
  dependencies:
    - build-macos-arm64
  script:
    - echo "Packaging macOS ARM64 binaries..."
    - apt-get update -qq && apt-get install -y -qq tar
    - mkdir -p release/macos-arm64
    - cp build/release/arm64-apple-darwin/src/Pastellad build/release/arm64-apple-darwin/src/Pastella-Wallet build/release/arm64-apple-darwin/src/Pastella-Wallet-API release/macos-arm64/
    - cd release && tar -czf pastellacore-macos-arm64-$CI_COMMIT_TAG.tar.gz macos-arm64/
  artifacts:
    name: "pastellacore-macos-arm64-package"
    paths:
      - release/*.tar.gz
    expire_in: 1 month
  only:
    - tags
    - main
